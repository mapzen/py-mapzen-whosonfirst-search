#!/usr/bin/env python

import sys
import os.path
import logging
import geojson

import mapzen.whosonfirst.utils

# See this - it is poorly namespaced. It needs to be improved but this involves
# becoming angry because that is what namespaces in Python do. So I am not doing
# it today... (20150730/thisisaaronland)

import whosonfirst

if __name__ == '__main__':

    import optparse
    opt_parser = optparse.OptionParser()

    opt_parser.add_option('-s', '--source', dest='source', action='store', default=None, help='Where to read files from')
    opt_parser.add_option('-v', '--verbose', dest='verbose', action='store_true', default=False, help='Be chatty (default is false)')
    options, args = opt_parser.parse_args()

    if options.verbose:	
        logging.basicConfig(level=logging.DEBUG)
    else:
        logging.basicConfig(level=logging.INFO)

    # See above inre namespaces
    idx = whosonfirst.search()

    source = os.path.abspath(options.source)
    crawl = mapzen.whosonfirst.utils.crawl(source)

    # something something something multiprocessing
    # something something something I bet ES freaks out and cries
    # (2015730/thisisaaronland)

    for path in crawl:
        try:
            idx.index_file(path)
        except Exception, e:
            logging.error("failed to index %s, because %s" % (path, e))

    # because this:

    """
File "./wof-es-index", line 36, in <module>
    rsp = idx.index_files(crawl)
  File "/usr/local/mapzen/py-mapzen-whosonfirst-search/scripts/whosonfirst.py", line 114, in index_files
    return elasticsearch.helpers.bulk(self.es, iter)
  File "build/bdist.linux-x86_64/egg/elasticsearch/helpers/__init__.py", line 182, in bulk
  File "build/bdist.linux-x86_64/egg/elasticsearch/helpers/__init__.py", line 155, in streaming_bulk
elasticsearch.helpers.BulkIndexError: ('4 document(s) failed to index.', [{u'index': {u'status': 400, u'_type': u'country', u'_id': u'85633051', u'error': u'WriteFailureException; nested: MapperParsingException[failed to parse [ne:fips_10_]]; nested: NumberFormatException[For input string: "SZ"]; ', u'_index': u'whosonfirst'}}, {u'index': {u'status': 400, u'_type': u'country', u'_id': u'85633001', u'error': u'MapperParsingException[failed to parse [ne:fips_10_]]; nested: NumberFormatException[For input string: "BU"]; ', u'_index': u'whosonfirst'}}, {u'index': {u'status': 400, u'_type': u'country', u'_id': u'85633057', u'error': u'WriteFailureException; nested: MapperParsingException[failed to parse [ne:fips_10_]]; nested: NumberFormatException[For input string: "CI"]; ', u'_index': u'whosonfirst'}}, {u'index': {u'status': 400, u'_type': u'country', u'_id': u'85633009', u'error': u'WriteFailureException; nested: MapperParsingException[failed to parse [ne:fips_10_]]; nested: NumberFormatException[For input string: "BR"]; ', u'_index': u'whosonfirst'}}])
    """

    # rsp = idx.index_files(crawl)
    # print rsp

